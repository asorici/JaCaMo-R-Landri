{% extends "base.html" %}

{% load url from future %}

{% block extrastyle %}

<style type="text/css">
.offline-test-formtable {
    display: none;
}
</style>

<link href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.1/css/jquery.dataTables.css" rel="stylesheet" type="text/css"//>
<link href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.1/css/jquery.dataTables_themeroller.css" rel="stylesheet" type="text/css"//>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.1/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js" type="text/javascript"></script>
<script src="/resources/jeditable/jquery.jeditable.mini.js" type="text/javascript"></script>
<script src="/resources/jeditable/jquery.dataTables.editable.js" type="text/javascript"></script>
<script src="/resources/rlandri/util.js" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function () {
        function handleJsonTests(data) {
            var offlineTests = rlandri.util.parseJSON(data.offlineTests, []);
            var solutions = rlandri.util.parseJSON(data.solutions, []);
            var solutionMap = rlandri.util.constructPrimaryMap(solutions);
            var aaData = [];
            for (var i in offlineTests) {
                var offlineTest = offlineTests[i];
                var fields = offlineTest.fields;
                if (fields) {
                    var solution = solutionMap[fields.solution];
                    var file = rlandri.util.getModelField(solution, 'file');
                    if (file) {
                        var tokens = file.split('/');
                        for (var i = tokens.length - 1; i >= 0; i--) {
                            var token = tokens[i];
                            if (token) {
                                file = token;
                                break;
                            }
                        }
                    }
                    aaData.push([ file, fields.numAgents ]);
                }
            }
            var aoColumns = [
                { "sTitle": "Agent File" },
                { "sTitle": "Number of Agents", "sClass": "center" },
            ];
            var otTable = $('#id_offline_test_table').dataTable({
                "aaData": aaData,
                "aoColumns": aoColumns,
                "bDestroy": true,
                "bAutoWidth": false,
                "bJQueryUI": true,
                "sPaginationType": "full_numbers",
            });
            otTable.makeEditable({
                sUpdateURL: '{% url 'simulator.views.jUpdateOfflineTests' %}',
                aoColumns: [
                    null,
                    {
                        oValidationOptions: {
                            rules: {
                                'value': {
                                    required: true,
                                    number: true,
                                    min: 0,
                                },
                            },
                        },
                    },
                ],
            });
            var nodes = otTable.fnGetNodes();
            for (var i in offlineTests) {
                var test = offlineTests[i];
                if (i in nodes && test.fields) {
                    nodes[i].id = test.fields.solution;
                }
            }
        }

        $("select#id_subenvironment").change(function () {
            var subEnv = $(this).val();
            if (subEnv) {
                var url = "{% url 'simulator.views.getsolutions' '0' %}";
                url = url.replace('0', subEnv);
                $.getJSON(url, handleJsonTests);
            }
        });

    function trimSuffix(str, suffix) {
        var index = str.lastIndexOf(suffix);
        if (index >= 0)
            return str.substring(0, index);
        else
            return '';
    }

    function createTable(subEnvId, aaData, cellIds, rowIds) {
            aaData = rlandri.util.parseJSON(aaData, [ ]);
            cellIds = rlandri.util.parseJSON(cellIds, [ ]);
            rowIds = rlandri.util.parseJSON(rowIds, [ ]);

            var numRows = aaData.length;
            for (var i = 0; i < numRows; i++) {
                var row = aaData[i];
                var numCols = row.length;
                for (var j = 0; j < numCols; j++) {
                    var cell = row[j];
                    var errors = cell[1];
                    var tpl = (errors.length > 0) ? '{0} ({1})' : '{0}';
                    row[j] = $.validator.format(tpl, cell[0], errors);
                }
            }

            var aoColumns = [
                { "sTitle": "Agent File" },
                { "sTitle": "Number of Agents", "sClass": "center" },
            ];
            var tableTpl = '#offline-test-realtable-{0}';
            var tableId = $.validator.format(tableTpl, subEnvId);
            var otTable = $(tableId).dataTable({
                "aaData": aaData,
                "aoColumns": aoColumns,
                "bDestroy": true,
                "bAutoWidth": false,
                "bJQueryUI": true,
                "sPaginationType": "full_numbers",
            });
            otTable.makeEditable({
                sUpdateURL: function (value, settings) {
                    var cellId = trimSuffix(this.id, "-realtable");
                    if (cellId) {
                        $('#' + cellId).val(value);
                        var forms = $('#offline-test-form-' + subEnvId);
                        forms.each(function(idx) {
                            this.submit();
                        });
                    }
                    return "ok";
                },
                oEditableSettings: {
                    event: 'click',
                },
                aoColumns: [
                    null,
                    {
                        oValidationOptions: {
                            rules: {
                                'value': {
                                    required: true,
                                    number: true,
                                    min: 0,
                                },
                            },
                        },
                    },
                ],
            });
            var nodes = otTable.fnGetNodes();
            var numNodes = Math.min(nodes.length, cellIds.length);
            for (var i = 0; i < numNodes; i++) {
                var cells = nodes[i].cells;
                var ids = cellIds[i];
                var numCells = Math.min(cells.length, ids.length);
                for (var j = 0; j < numCells; j++) {
                    var cellId = ids[j] + "-realtable";
                    cells[j].id = cellId;
                }
            }
            numNodes = Math.min(nodes.length, rowIds.length);
            for (var i = 0; i < numNodes; i++) {
                nodes[i].id = rowIds[i];
            }
    }

{% for test in allTests %}
{% with test.subEnvironment as subEnv %}
{% with test.formset as formset %}
    createTable('{{ subEnv.id|escapejs }}', '{{ test.aaData|escapejs }}',
        '{{ test.cellIds|escapejs }}', '{{ test.rowIds|escapejs }}');
{% endwith %}
{% endwith %}
{% endfor %}
    });

    $(function () {
        $("#offline-test-accordion").accordion({
            autoHeight: false,
        });
    });
</script>

{% endblock %}

{% block app-content %}

<div id="offline-test-accordion">
{% for test in allTests %}
{% with subEnvironment=test.subEnvironment formset=test.formset %}
    <h3>
        <a href="#"> {{ subEnvironment }} </a>
    </h3>
    <div>

    <table id="offline-test-realtable-{{ subEnvironment.id }}">
    </table>
    <form action="{% url 'simulator.views.simulate_post' subEnvironment.pk %}"
        id="offline-test-form-{{ subEnvironment.id }}" method="post">{% csrf_token %}
        <table class="offline-test-formtable">
            {{ formset }}
        </table>
    </form>
    </div>
{% endwith %}
{% endfor %}
</div>

{% endblock %}
